<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AnonyChat Admin Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @media (max-width: 768px) {
            .responsive-table thead {display: none;}
            .responsive-table tbody, .responsive-table tr, .responsive-table td {display: block;width: 100%;}
            .responsive-table tr {margin-bottom: 1rem;border: 1px solid #e2e8f0;border-radius: 0.75rem;overflow: hidden;}
            .responsive-table td {display: flex;justify-content: space-between;align-items: center;text-align: right;padding: 0.75rem 1rem;border-bottom: 1px solid #edf2f7;}
            .responsive-table td::before {content: attr(data-label);font-weight: 600;text-align: left;margin-right: 1rem;color: #4a5568;}
        }
        .status-dot { height: 10px; width: 10px; border-radius: 50%; display: inline-block; animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    </style>
</head>
<body class="bg-slate-100 text-slate-800">
    <div class="container mx-auto p-4 md:p-8">
        <header class="flex flex-wrap justify-between items-center mb-8 gap-4">
            <div><h1 class="text-3xl font-bold text-slate-800">üõ°Ô∏è AnonyChat Dashboard</h1><p class="text-slate-500">Panel Kontrol Bot Anda</p></div>
            <div class="text-sm text-slate-500" id="status-text">Menunggu update...</div>
        </header>
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-8">
             <div class="lg:col-span-1 space-y-8">
                <div class="p-6 bg-white rounded-xl shadow-lg">
                    <h2 class="text-xl font-semibold mb-4 border-b pb-2">üö¶ Status Bot</h2>
                    <div class="flex items-center space-x-3 mb-4"><span id="status-dot" class="status-dot bg-gray-400"></span><span id="status-label" class="font-medium text-lg">Inisialisasi...</span></div>
                </div>
                <div id="qr-code-container" class="text-center p-4 bg-white border-2 border-dashed rounded-xl shadow-lg hidden">
                    <p class="mb-2 font-semibold">Silakan Scan QR Code untuk Login</p>
                    <img id="qr-code-image" src="" alt="QR Code" class="mx-auto w-full max-w-xs">
                </div>
            </div>
            <div class="lg:col-span-2 p-6 bg-white rounded-xl shadow-lg" id="anon-status-section"></div>
        </div>
        <div class="mb-8 p-6 bg-white rounded-xl shadow-lg">
            <h2 class="text-xl font-semibold mb-4 border-b pb-2 flex items-center">üì£ Kirim Pesan Broadcast</h2>
            <form id="broadcast-form">
                <div class="mb-4">
                    <label for="broadcast-message" class="block text-sm font-medium text-slate-600 mb-1">Tulis pesan Anda di sini:</label>
                    <textarea name="message" id="broadcast-message" rows="4" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:border-indigo-500 focus:ring-indigo-500" placeholder="Contoh: Halo semua, bot akan offline untuk maintenance."></textarea>
                </div>
                <button type="submit" id="broadcast-button" class="w-full inline-flex justify-center items-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700">
                    <span id="button-text">Kirim ke Semua Pengguna Aktif</span>
                    <svg id="button-spinner" class="animate-spin ml-2 h-5 w-5 text-white hidden" xmlns="http://www.w.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                </button>
                <p class="mt-3 text-xs text-rose-600">‚ö†Ô∏è **Peringatan:** Gunakan dengan hati-hati. Risiko nomor diblokir.</p>
                <div id="broadcast-progress-section" class="mt-4 hidden">
                    <div class="text-sm font-medium text-slate-700 mb-1" id="progress-text">Mengirim...</div>
                    <div class="w-full bg-gray-200 rounded-full h-2.5"><div id="progress-bar" class="bg-blue-600 h-2.5 rounded-full" style="width: 0%"></div></div>
                </div>
                <div id="broadcast-status" class="mt-3 text-sm text-green-700 font-semibold"></div>
            </form>
        </div>
        <div>
            <div class="mb-4 border-b border-gray-200">
                <nav class="-mb-px flex space-x-8" aria-label="Tabs">
                    <button onclick="changeTab('users')" class="tab-button border-indigo-500 text-indigo-600 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">Manajemen User</button>
                    <button onclick="changeTab('violations')" class="tab-button border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">Log Pelanggaran</button>
                    <button onclick="changeTab('logs')" class="tab-button border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">Aktivitas Bot</button>
                </nav>
            </div>
            <div id="users-content" class="tab-content bg-white rounded-lg shadow-lg overflow-hidden"></div>
            <div id="violations-content" class="tab-content bg-white rounded-lg shadow-lg overflow-hidden hidden"></div>
            <div id="logs-content" class="tab-content bg-slate-800 text-white font-mono text-xs rounded-b-lg shadow-lg hidden"></div>
        </div>
    </div>
    <div id="chat-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50 p-4">
        <div class="bg-white rounded-lg shadow-xl w-full sm:w-11/12 md:w-1/2 max-h-[80vh] flex flex-col">
            <div class="p-4 border-b flex justify-between items-center"><h2 class="text-xl font-bold" id="modal-room-id"></h2><button onclick="closeModal()" class="text-gray-500 hover:text-gray-800 text-3xl">&times;</button></div>
            <div class="p-4 overflow-y-auto" id="modal-chat-content"></div>
        </div>
    </div>
    <script>
        const updateInterval = 3000; let cachedData = {};
        function changeTab(tabName) {
            ['users', 'violations', 'logs'].forEach(tab => {
                document.getElementById(`${tab}-content`).classList.add('hidden');
                document.querySelector(`button[onclick="changeTab('${tab}')"]`).classList.remove('border-indigo-500', 'text-indigo-600');
                document.querySelector(`button[onclick="changeTab('${tab}')"]`).classList.add('border-transparent', 'text-gray-500');
            });
            document.getElementById(`${tabName}-content`).classList.remove('hidden');
            document.querySelector(`button[onclick="changeTab('${tabName}')"]`).classList.add('border-indigo-500', 'text-indigo-600');
        }
        function renderBotStatus(status, qrCode) {
            const dot = document.getElementById('status-dot'); const label = document.getElementById('status-label'); const qrContainer = document.getElementById('qr-code-container'); const qrImage = document.getElementById('qr-code-image');
            dot.className = 'status-dot';
            if (status === 'CONNECTED') { dot.classList.add('bg-green-500'); label.textContent = 'Terhubung'; qrContainer.classList.add('hidden');
            } else if (status === 'WAITING_FOR_QR_SCAN') { dot.classList.add('bg-yellow-500'); label.textContent = 'Menunggu Scan QR...'; if (qrCode) { qrImage.src = qrCode; qrContainer.classList.remove('hidden'); }
            } else if (status === 'DISCONNECTED') { dot.classList.add('bg-red-500'); label.textContent = 'Terputus'; qrContainer.classList.add('hidden');
            } else { dot.classList.add('bg-gray-400'); label.textContent = 'Inisialisasi...'; qrContainer.classList.add('hidden'); }
        }
        function renderServerLogs(logs) {
            const container = document.getElementById('logs-content');
            let logHTML = `<div class="p-4 h-96 overflow-y-auto">`;
            logs.slice().reverse().forEach(log => { logHTML += `<div><span class="text-green-400">${log.timestamp}:</span><span class="text-slate-300"> ${log.message}</span></div>`; });
            logHTML += `</div>`; container.innerHTML = logHTML;
        }
        function renderAnonStatus(data) {
            const container = document.getElementById('anon-status-section');
            let statusHTML = `<h2 class="text-xl font-semibold mb-4 border-b pb-2">üíû Status Anonymous Chat</h2><div class="grid md:grid-cols-2 gap-6"><div><h3 class="font-bold mb-2">üë• Menunggu Partner (${data.waiting.length})</h3><div class="text-gray-600 h-32 overflow-y-auto bg-gray-50 p-3 rounded-lg">${data.waiting.length > 0 ? data.waiting.map(u => `<div>- ${u.nickname}</div>`).join('') : '<div class="text-gray-400">Tidak ada yang menunggu...</div>'}</div></div><div><h3 class="font-bold mb-2">üí¨ Room Aktif (${data.active.length})</h3><div class="text-gray-600 h-32 overflow-y-auto bg-gray-50 p-3 rounded-lg">${data.active.length > 0 ? data.active.map(p => `<div>- <a href="#" onclick="showChatLog('${p.roomId}')" class="text-blue-500 hover:underline font-semibold">${p.roomId}</a>: ${p.user1} ‚Üî ${p.user2}</div>`).join('') : '<div class="text-gray-400">Tidak ada yang aktif...</div>'}</div></div></div>`;
            container.innerHTML = statusHTML;
        }
        function renderUserTable(users) {
            const container = document.getElementById('users-content');
            let tableHTML = `<div class="overflow-x-auto"><table class="w-full text-sm text-left text-gray-500 responsive-table"><thead class="bg-gray-50 text-xs uppercase text-gray-700"><tr><th class="px-6 py-3">Nickname</th><th class="px-6 py-3">Status</th><th class="px-6 py-3 text-center">Aksi</th></tr></thead><tbody>`;
            users.forEach(user => {
                const isBannedClass = user.isBanned ? 'bg-rose-50' : '';
                const statusBadge = user.isBanned ? `<span class="px-2 py-1 text-xs font-semibold text-white bg-rose-500 rounded-full">Banned</span>` : `<span class="px-2 py-1 text-xs font-semibold text-white bg-teal-500 rounded-full">Aktif</span>`;
                const banButton = user.isBanned ? `<button type="submit" class="px-3 py-1 bg-sky-500 text-white text-xs rounded-md hover:bg-sky-600">Unban</button>` : `<button type="submit" class="px-3 py-1 bg-rose-500 text-white text-xs rounded-md hover:bg-rose-600">Ban</button>`;
                tableHTML += `<tr class="border-b hover:bg-gray-50 ${isBannedClass}"><td data-label="Nickname" class="px-6 py-4 font-medium text-gray-900">${user.nickname}<span class="text-gray-500 text-xs block">${user.id.split('@')[0]}</span></td><td data-label="Status" class="px-6 py-4">${statusBadge}</td><td data-label="Aksi" class="px-6 py-4 flex items-center justify-end md:justify-center"><form action="/toggle-ban" method="POST" class="contents"><input type="hidden" name="userId" value="${user.id}">${banButton}</form></td></tr>`;
            });
            tableHTML += `</tbody></table></div>`; container.innerHTML = tableHTML;
        }
        function renderViolationTable(violations) {
            const container = document.getElementById('violations-content');
            let tableHTML = `<h2 class="text-xl font-semibold p-4 border-b">üö´ Log Pelanggaran</h2><div class="overflow-x-auto"><table class="w-full text-sm text-left text-gray-500 responsive-table"><thead class="bg-gray-50 text-xs uppercase text-gray-700"><tr><th class="px-6 py-3">Waktu</th><th class="px-6 py-3">Tipe</th><th class="px-6 py-3">Pelaku/Pelapor</th><th class="px-6 py-3">Detail</th></tr></thead><tbody>`;
            violations.slice().reverse().forEach((v, index) => {
                let reporterInfo = v.type === 'Laporan Pengguna' ? `<div class="font-bold text-red-600">Pelapor: ${v.reporter.nickname}</div><div class="text-gray-500">Terlapor: ${v.reported.nickname}</div>` : `<div class="font-bold">${v.nickname}</div>`;
                let detailInfo = v.type === 'Laporan Pengguna' ? `<button onclick="showReportedChat(${violations.length - 1 - index})" class="text-blue-500 hover:underline">Lihat Chat</button>` : `<span class="text-red-600">${v.message}</span>`;
                tableHTML += `<tr class="border-b hover:bg-gray-50"><td data-label="Waktu" class="px-6 py-4 text-gray-500 whitespace-nowrap">${v.timestamp}</td><td data-label="Tipe" class="px-6 py-4 font-semibold">${v.type}</td><td data-label="Pelaku/Pelapor" class="px-6 py-4">${reporterInfo}</td><td data-label="Detail" class="px-6 py-4">${detailInfo}</td></tr>`;
            });
            tableHTML += `</tbody></table></div>`; container.innerHTML = tableHTML;
        }
        const modal = document.getElementById('chat-modal'); async function showChatLog(roomId) { document.getElementById('modal-room-id').textContent = `Isi Chat Room: ${roomId}`; const contentDiv = document.getElementById('modal-chat-content'); contentDiv.innerHTML = 'Memuat chat...'; modal.classList.remove('hidden'); try { const response = await fetch(`/api/chatlog/${roomId}`); const logData = await response.json(); let chatHTML = '<div class="space-y-2">'; logData.forEach(chat => { chatHTML += `<div><span class="font-bold text-blue-600">${chat.nickname}:</span> ${chat.message} <span class="text-xs text-gray-400 float-right">${chat.timestamp.split(' ')[1]}</span></div>`; }); chatHTML += '</div>'; contentDiv.innerHTML = chatHTML; } catch (error) { contentDiv.innerHTML = 'Gagal memuat log chat.'; } }
        function showReportedChat(violationIndex) { const violation = cachedData.violations.slice().reverse()[violationIndex]; document.getElementById('modal-room-id').textContent = `Bukti Laporan Room: ${violation.roomId}`; const contentDiv = document.getElementById('modal-chat-content'); let chatHTML = '<div class="space-y-2">'; (violation.chatHistory || []).forEach(chat => { let colorClass = 'text-gray-800'; if (violation.reporter && chat.userId === violation.reporter.id) colorClass = 'text-green-600'; if (violation.reported && chat.userId === violation.reported.id) colorClass = 'text-red-600'; chatHTML += `<div><span class="font-bold ${colorClass}">${chat.nickname}:</span> ${chat.message}</div>`; }); chatHTML += '</div>'; contentDiv.innerHTML = chatHTML; modal.classList.remove('hidden'); }
        function closeModal() { modal.classList.add('hidden'); }
        async function updateAllData() {
            try {
                const [statusResponse, broadcastResponse] = await Promise.all([ fetch('/api/status'), fetch('/api/broadcast-status') ]);
                if (!statusResponse.ok || !broadcastResponse.ok) throw new Error('Gagal mengambil data.');
                const statusData = await statusResponse.json(); const broadcastData = await broadcastResponse.json(); const data = { ...statusData, broadcast: broadcastData };
                if (JSON.stringify(data) !== JSON.stringify(cachedData)) {
                    cachedData = data;
                    renderAnonStatus(data);
                    renderUserTable(data.users);
                    renderViolationTable(data.violations);
                }
                renderBotStatus(data.botStatus, data.qrCode);
                renderServerLogs(data.serverLogs);
                renderBroadcastStatus(data.broadcast);
                document.getElementById('status-text').textContent = `Data diperbarui pada: ${new Date().toLocaleTimeString('id-ID')}`;
            } catch (error) { console.error("Gagal update data:", error); document.getElementById('status-text').textContent = "Gagal memuat data."; renderBotStatus('DISCONNECTED', ''); }
        };
        const broadcastForm = document.getElementById('broadcast-form');
        broadcastForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const message = document.getElementById('broadcast-message').value;
            if (!message || message.trim() === '') return;
            const broadcastStatusDiv = document.getElementById('broadcast-status'); broadcastStatusDiv.textContent = '';
            renderBroadcastStatus({ isRunning: true, progress: 0, total: 'N/A', currentUser: 'Memulai...'});
            try {
                const response = await fetch('/broadcast', { method: 'POST', headers: { 'Content-Type': 'application/x-www-form-urlencoded' }, body: `message=${encodeURIComponent(message)}` });
                const resultText = await response.text();
                broadcastStatusDiv.textContent = resultText;
                document.getElementById('broadcast-message').value = '';
                setTimeout(() => { broadcastStatusDiv.textContent = ''; }, 7000);
            } catch (error) { broadcastStatusDiv.textContent = "Gagal mengirim broadcast."; }
        });
        function renderBroadcastStatus(status) {
            const progressSection = document.getElementById('broadcast-progress-section'); const progressBar = document.getElementById('progress-bar'); const progressText = document.getElementById('progress-text'); const broadcastButton = document.getElementById('broadcast-button'); const buttonText = document.getElementById('button-text'); const buttonSpinner = document.getElementById('button-spinner');
            if (status.isRunning) {
                progressSection.classList.remove('hidden'); const percent = status.total > 0 ? (status.progress / status.total) * 100 : 0;
                progressBar.style.width = `${percent}%`; progressText.textContent = `Mengirim ke ${status.currentUser} (${status.progress}/${status.total})...`;
                buttonText.textContent = 'Mengirim...'; buttonSpinner.classList.remove('hidden'); broadcastButton.disabled = true;
            } else {
                if (cachedData?.broadcast?.isRunning) { progressText.textContent = `Broadcast Selesai!`; } else { progressSection.classList.add('hidden'); }
                buttonText.textContent = 'Kirim ke Semua Pengguna Aktif'; buttonSpinner.classList.add('hidden'); broadcastButton.disabled = false;
            }
        }
        updateAllData();
        setInterval(updateAllData, updateInterval);
        setInterval(updateBroadcastStatus, 2000);
    </script>
</body>
</html>
